# v1.0.8 Feature Implementation - Overwrite Mode for Auto-Naming

**Date**: 2025-10-13
**Branch**: `feature/overwrite-mode`
**Status**: ✅ Complete and Tested

---

## Overview

Implemented configurable file naming strategy for exported diagrams, allowing users to choose between versioned exports (preserving history) and overwrite mode (consistent filenames for presentations).

### User Problem

Users integrating Mermaid diagrams into presentation frameworks (Marp, reveal.js) need consistent asset filenames. The existing versioned naming system (`diagram-01-a4b2c8ef.svg`) creates new files on each export, breaking presentation asset references.

### Solution

Added `mermaidExportPro.autoNaming.mode` configuration with two modes:

1. **versioned** (default): `diagram-01-a4b2c8ef.svg`
   - Preserves export history
   - Content-based deduplication via hash
   - Safe for version control

2. **overwrite**: `diagram1.svg`
   - Consistent filenames
   - Overwrites previous exports
   - Ideal for presentations with fixed asset paths

---

## Implementation Details

### Files Modified

| File | Changes | Lines |
|------|---------|-------|
| `package.json` | Added configuration property with markdown description | +19 |
| `src/types/index.ts` | Added `AutoNamingMode` type and ConfigurationManager method | +2 |
| `src/services/configManager.ts` | Added `getAutoNamingMode()` getter method | +5 |
| `src/utils/autoNaming.ts` | Added `generateFileName()` and `generateOverwriteName()` methods | +42 |
| `src/commands/exportCommand.ts` | Integrated naming mode with export logic | +8 |
| `src/extension.ts` | Updated auto-export paths to use new naming mode | +6 |
| `src/test/unit/utils/autoNaming.test.ts` | Added 7 new test cases for overwrite mode | +98 |
| `src/test/unit/commands/exportCommand.test.ts` | Updated mocks to support new methods | +6 |
| `CHANGELOG.md` | Documented v1.0.8 release | +31 |
| `README.md` | Updated settings section with new configuration | +3 |

**Total**: 10 files modified, 240 insertions(+), 20 deletions(-)

---

## Technical Implementation

### 1. Type System

```typescript
// src/types/index.ts
export type AutoNamingMode = 'versioned' | 'overwrite';

export interface ConfigurationManager {
  // ... existing methods
  getAutoNamingMode(): AutoNamingMode;
}
```

### 2. Configuration Management

```typescript
// src/services/configManager.ts
getAutoNamingMode(): AutoNamingMode {
  return this.getConfiguration().get<AutoNamingMode>('autoNaming.mode', 'versioned');
}
```

### 3. Auto-Naming Logic

```typescript
// src/utils/autoNaming.ts
static async generateFileName(options: AutoNameOptions): Promise<string> {
  const mode = options.mode || 'versioned';

  switch (mode) {
    case 'overwrite':
      return this.generateOverwriteName(options);
    case 'versioned':
    default:
      return this.generateSmartName(options);
  }
}

private static async generateOverwriteName(options: AutoNameOptions): Promise<string> {
  const { baseName, format, outputDirectory } = options;

  // Extract diagram number: diagram1 -> 1, architecture-flow2 -> 2
  const numberMatch = baseName.match(/(\d+)$/);
  const diagramNumber = numberMatch ? numberMatch[1] : '1';

  // Clean base name: architecture-flow2 -> architecture-flow
  const cleanBaseName = baseName.replace(/[-_]?\d+$/, '');

  // Build filename: diagram1.svg
  const fileName = `${cleanBaseName}${diagramNumber}.${format}`;

  return path.join(outputDirectory, fileName);
}
```

### 4. Integration Points

**Export Commands** ([exportCommand.ts:119-129](src/commands/exportCommand.ts#L119-L129)):
```typescript
const configManager = new ConfigManager();
const namingMode = configManager.getAutoNamingMode();
outputPath = await AutoNaming.generateFileName({
  baseName: path.basename(document.fileName, path.extname(document.fileName)),
  format: exportOptions.format,
  content: mermaidContent,
  outputDirectory: outputDir,
  mode: namingMode
});
```

**Extension Auto-Save** ([extension.ts:674-687](src/extension.ts#L674-L687)):
```typescript
const configManager = new ConfigManager();
const namingMode = configManager.getAutoNamingMode();
return await AutoNaming.generateFileName({
  baseName,
  format,
  content: mermaidContent,
  outputDirectory: fileDirectory,
  mode: namingMode
});
```

---

## Testing

### Test Coverage

Added **7 new unit tests** for overwrite mode functionality:

1. ✅ Defaults to versioned mode when mode not specified
2. ✅ Generates versioned name when mode=versioned
3. ✅ Generates simple overwrite name when mode=overwrite
4. ✅ Overwrite mode extracts diagram number from baseName
5. ✅ Overwrite mode defaults to 1 when no number in baseName
6. ✅ Overwrite mode handles different formats
7. ✅ Overwrite mode produces consistent names for same input

### Test Results

```
Test Files  27 passed (27)
Tests       350 passed | 1 skipped (351)
Duration    7.78s
```

### Cross-Platform Validation

Tests use `path.basename()` and relative path matching to ensure compatibility across Windows, macOS, and Linux.

---

## Configuration

### VS Code Settings

**JSON**:
```json
{
  "mermaidExportPro.autoNaming.mode": "overwrite"
}
```

**UI Settings**:
- Open Settings → Extensions → Mermaid Export Pro
- Find "Auto Naming: Mode"
- Select "overwrite" from dropdown

### Package.json Definition

```json
{
  "mermaidExportPro.autoNaming.mode": {
    "type": "string",
    "enum": ["versioned", "overwrite"],
    "default": "versioned",
    "markdownDescription": "**File naming strategy for exported diagrams:**\n\n- `versioned` **(default)**: Create new file with sequence and hash (`diagram-01-a4b2c8ef.svg`)\n  - ✅ Preserves export history\n  - ✅ Content-based deduplication\n  - ✅ Safe for version control\n\n- `overwrite`: Overwrite existing file with simple name (`diagram1.svg`)\n  - ✅ Consistent filenames for presentations\n  - ✅ No duplicate files\n  - ⚠️ Previous exports are replaced\n\n**Use Case:** Enable `overwrite` mode for presentations (Marp, reveal.js) that need consistent asset paths."
  }
}
```

---

## Examples

### Versioned Mode (Default)

```
Input:  diagram1.mmd
Output: diagram-01-a4b2c8ef.svg
        diagram-02-b3c1d9fa.svg  (after modification)
        diagram-03-c2d8e4fb.svg  (another change)
```

### Overwrite Mode

```
Input:  diagram1.mmd
Output: diagram1.svg
        diagram1.svg  (overwrites previous)
        diagram1.svg  (always same filename)
```

### Presentation Workflow

**Marp Slide**:
```markdown
---
marp: true
---

# Architecture Diagram

![](./diagram1.svg)
```

With overwrite mode enabled, exports always update `diagram1.svg` without breaking the Marp reference.

---

## Documentation Updates

### CHANGELOG.md

- Added v1.0.8 section documenting:
  - New feature description
  - Configuration details
  - Use cases
  - Test coverage

### README.md

- Updated Extension Settings section
- Added new configuration with sub-items explaining modes
- Marked as "NEW in v1.0.8!"

### Feature Specification

Comprehensive specification document created at:
- `docs/features/OVERWRITE-MODE-FEATURE.md`

---

## Branch Status

### Current State

- ✅ Feature branch: `feature/overwrite-mode`
- ✅ All tests passing: 350/351 tests (99.7%)
- ✅ Documentation complete
- ✅ Committed: `bf89d5b`

### Next Steps

1. **Code Review**: Review implementation for quality and edge cases
2. **Manual Testing**: Test in real presentation scenarios (Marp, reveal.js)
3. **Merge to Master**: Create PR and merge after approval
4. **Tag Release**: Create v1.0.8 tag
5. **Publish VSIX**: Build and publish to VS Code Marketplace

---

## Metrics

| Metric | Value |
|--------|-------|
| Implementation Time | ~4 hours (as estimated) |
| Files Modified | 10 |
| Lines Added | 240 |
| Lines Removed | 20 |
| Tests Added | 7 |
| Test Pass Rate | 99.7% (350/351) |
| Code Coverage | ~46% (maintained) |

---

## Related Documents

- Feature Specification: `docs/features/OVERWRITE-MODE-FEATURE.md`
- GitHub Issue Template: `docs/features/GITHUB-ISSUE-OVERWRITE-MODE.md`
- v1.0.7 Release: `reports/V1.0.7-RELEASE-COMPLETE.md`

---

**Implementation Complete** ✅
**Ready for Review and Merge**
